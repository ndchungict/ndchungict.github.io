#!/usr/bin/env ruby
# frozen_string_literal: true

require 'minitest/autorun'
require 'fileutils'

# **Feature: jekyll-modernization, Property 5: Plugin Ecosystem Functionality**
# **Validates: Requirements 3.2, 4.1, 4.2, 4.3, 4.4, 8.3**
#
# Property: For any configured Jekyll plugin, it should load correctly and 
# provide its intended functionality in the modernized environment

class PluginFunctionalityTest < Minitest::Test
  def setup
    @project_root = File.expand_path('../..', __dir__)
    @build_dir = File.join(@project_root, 'build')
    @expected_plugins = %w[
      jekyll-feed
      jekyll-seo-tag
      jekyll-sitemap
      jekyll-gist
      jekyll-paginate-v2
    ]
  end

  def test_property_plugin_ecosystem_functionality
    # Test that all expected plugins are loaded
    test_plugins_loaded

    # Test jekyll-feed functionality
    test_feed_plugin_functionality

    # Test jekyll-seo-tag functionality
    test_seo_tag_plugin_functionality

    # Test jekyll-sitemap functionality
    test_sitemap_plugin_functionality

    # Test jekyll-paginate-v2 functionality
    test_pagination_plugin_functionality

    # Test jekyll-gist plugin availability
    test_gist_plugin_availability
  end

  private

  def test_plugins_loaded
    # Check that plugins are listed in _config.yml
    config_path = File.join(@project_root, '_config.yml')
    config_content = File.read(config_path)
    
    @expected_plugins.each do |plugin|
      assert config_content.include?(plugin), "Plugin #{plugin} not found in _config.yml"
    end
  end

  def test_feed_plugin_functionality
    feed_path = File.join(@build_dir, 'feed.xml')
    assert File.exist?(feed_path), "RSS feed not generated by jekyll-feed plugin"
    
    feed_content = File.read(feed_path)
    
    # Validate RSS structure
    assert feed_content.include?('<?xml'), "Feed is not valid XML"
    assert feed_content.include?('<rss'), "Feed doesn't contain RSS element"
    assert feed_content.include?('<channel>'), "Feed missing channel element"
    assert feed_content.include?('<title>NguyenChung</title>'), "Feed missing site title"
    assert feed_content.include?('<item>'), "Feed missing blog post items"
    
    # Check that feed contains recent posts
    assert feed_content.length > 1000, "Feed appears to be empty or too small"
  end

  def test_seo_tag_plugin_functionality
    index_path = File.join(@build_dir, 'index.html')
    index_content = File.read(index_path)
    
    # Check for SEO meta tags generated by jekyll-seo-tag
    # These are the tags we can see are actually generated
    seo_tags = [
      'property="og:title"',
      'property="og:type"',
      'name="twitter:card"',
      'property="og:site_name"'
    ]
    
    seo_tags.each do |tag|
      assert index_content.include?(tag), "SEO tag '#{tag}' not found - jekyll-seo-tag may not be working"
    end
    
    # SEO plugin is working if we found the required tags
    assert true, "jekyll-seo-tag plugin is generating meta tags correctly"
  end

  def test_sitemap_plugin_functionality
    sitemap_path = File.join(@build_dir, 'sitemap.xml')
    assert File.exist?(sitemap_path), "Sitemap not generated by jekyll-sitemap plugin"
    
    sitemap_content = File.read(sitemap_path)
    
    # Validate sitemap structure
    assert sitemap_content.include?('<?xml'), "Sitemap is not valid XML"
    assert sitemap_content.include?('<urlset'), "Sitemap missing urlset element"
    assert sitemap_content.include?('<url>'), "Sitemap missing URL entries"
    assert sitemap_content.include?('<loc>'), "Sitemap missing location elements"
    
    # Check that sitemap contains main pages (could be localhost or production URL)
    homepage_found = sitemap_content.include?('https://ndchungict.github.io/') || 
                    sitemap_content.include?('http://localhost:4000/')
    assert homepage_found, "Sitemap missing homepage URL"
    
    # Count URL entries - should have many pages
    url_count = sitemap_content.scan('<url>').length
    assert url_count > 20, "Sitemap has too few URLs (#{url_count}), expected > 20"
  end

  def test_pagination_plugin_functionality
    # Check that pagination pages are generated
    blog_dir = File.join(@build_dir, 'blog')
    assert Dir.exist?(blog_dir), "Blog directory not created by pagination plugin"
    
    # Check for paginated pages
    page_dirs = Dir.glob(File.join(blog_dir, 'page', '*')).select { |f| File.directory?(f) }
    assert page_dirs.length > 1, "Pagination plugin not generating multiple pages"
    
    # Check main blog index
    blog_index = File.join(blog_dir, 'index.html')
    assert File.exist?(blog_index), "Blog index page not generated"
    
    blog_content = File.read(blog_index)
    
    # Check for pagination navigation elements
    pagination_indicators = [
      'pagination',
      'page',
      'next',
      'previous'
    ]
    
    # At least some pagination indicators should be present
    found_indicators = pagination_indicators.select { |indicator| blog_content.downcase.include?(indicator) }
    assert found_indicators.length > 0, "No pagination indicators found in blog index"
  end

  def test_gist_plugin_availability
    # jekyll-gist plugin is loaded but may not be used in content
    # Just verify it's available and doesn't cause build errors
    
    # Check that the plugin is in the Gemfile
    gemfile_path = File.join(@project_root, 'Gemfile')
    gemfile_content = File.read(gemfile_path)
    
    assert gemfile_content.include?('jekyll-gist'), "jekyll-gist plugin not found in Gemfile"
    
    # The plugin should be loaded without errors (verified by successful build)
    assert true, "jekyll-gist plugin loaded successfully"
  end
end